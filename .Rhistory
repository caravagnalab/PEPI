library(dplyr)
library(dplyr)
library(easypar)
rates = tibble(rn = c(rep(0.01,3),rep(0.005,3),rep(0.001,3),rep(0.05,3),rep(0.1,3),rep(0.5,3),rep(1,3)),
rp = c(rep(0.001,3),rep(0.005,3),rep(0.01,3),rep(0.05,3),rep(0.1,3),rep(0.5,3),rep(1,3)))
bc = tibble(lambda_n = c(1.5,1.2,1.0)*rep(1,21),
lambda_p = c(1.0,1.2,1.5)*rep(1,21),
t = c(5,7.5,7.5)*rep(1,21))
g = cbind(rates,bc) %>% as_tibble()
library(rRACES)
library(dplyr)
g[j,]$rn
j = 2
g[j,]$rn
g[j,]$rp
g[j,]$lambda_n
g[j,]$t
500/50
g
21*5
500/150
125/2
65*2
65*4
21*2
x <- readRDS("~/Orfeo/races/results/all_sims/1_counts.rds")
x
rates = tibble(rn = c(rep(0.01,3),rep(0.005,3),rep(0.001,3),rep(0.05,3),rep(0.1,3),rep(0.5,3)),
rp = c(rep(0.001,3),rep(0.005,3),rep(0.01,3),rep(0.05,3),rep(0.1,3),rep(0.5,3)))
library(dplyr)
rates = tibble(rn = c(rep(0.01,3),rep(0.005,3),rep(0.001,3),rep(0.05,3),rep(0.1,3),rep(0.5,3)),
rp = c(rep(0.001,3),rep(0.005,3),rep(0.01,3),rep(0.05,3),rep(0.1,3),rep(0.5,3)))
bc1 = tibble(lambda_n = c(1.5,1.2,1.0)*rep(1,9),
lambda_p = c(1.0,1.2,1.5)*rep(1,9),
t = c(10,15,15)*rep(1,9))
bc2 = tibble(lambda_n = c(1.5,1.2,1.0)*rep(1,9),
lambda_p = c(1.0,1.2,1.5)*rep(1,9),
t = c(10,10,10)*rep(1,9))
bc = rbind(bc1,bc2)
g = cbind(rates,bc) %>% as_tibble()
nrow(g)
50*10
x = list(a = 1,b = 2)
x$c
setwd("~/Documents/GitHub/ProjectPepi/models")
setwd("~/Documents/GitHub/ProjectPepi")
path_to_model = "models"
paste0(path_to_model,"/regressionODE.stan") %in% list.files(path_to_model)
list.files(path_to_model)
paste0(path_to_model,"/regressionODE.stan")
paste0(path_to_model,"/regressionODE.stan") %in% list.files(path_to_model)
list.files(path_to_model)
paste0(path_to_model,"/regressionODE.stan") %in% list.files(path_to_model)
list.files(path_to_model)
paste0(path_to_model,"/regressionODE.stan")
paste0(path_to_model,"/regressionODE.stan") %in% list.files(path_to_model)
setwd("~/Documents/GitHub/ProjectPepi")
dir.create(path_to_model)
source("~/Documents/GitHub/ProjectPepi/R/stan_generating_code.R")
counts_inference_code(likelihood = T)
model = counts_inference_code(likelihood = T)
write_stan_file(
model,
dir = ".",
basename = paste0(path_to_model,"/regressionODE.stan"),
force_overwrite = FALSE,
hash_salt = ""
)
library(rstan)
write_stan_file(
model,
dir = ".",
basename = paste0(path_to_model,"/regressionODE.stan"),
force_overwrite = FALSE,
hash_salt = ""
)
library(cmdstanr)
write_stan_file(
model,
dir = ".",
basename = paste0(path_to_model,"/regressionODE.stan"),
force_overwrite = FALSE,
hash_salt = ""
)
paste0(path_to_model,"/regressionODE.stan") %in% list.files(path_to_model)
paste0(path_to_model,"/regressionODE.stan") == list.files(path_to_model)
list.files(path_to_model)
!paste0(path_to_model,"/regressionODE.stan") %in% list.files(path_to_model)
!paste0(path_to_model,"/regressionODE.stan") %in% list.files(path_to_model)
paste0(path_to_model,"/regressionODE.stan")
path_to_model = "./models"
list.files(path_to_model)
!paste0(path_to_model,"/regressionODE.stan") %in% list.files(path_to_model)
x = c("a","b","c")
"a" %in% x
str(x)
str(list.files(path_to_model))
files(path_to_model)
list.files(path_to_model)
list.files(path_to_model) == "regressionODE.stan"
! "regressionODE.stan" %in% list.files(path_to_model)
! paste0("tree_inference_depth_",max_depth,".stan") %in% list.files(path_to_model)
max_depth = 2
! paste0("tree_inference_depth_",max_depth,".stan") %in% list.files(path_to_model)
! "/fitness_inference.stan" %in% list.files(path_to_model)
counts <- readRDS("~/Dropbox/races/results/1/counts.rds")
counts
counts %>% filter(time > 0) %>% pull(time) %>% unique()
library(dplyr)
counts %>% filter(time > 0) %>% pull(time) %>% unique()
counts %>% filter(time > 0, epistate = "+") %>% pull(counts)
counts
init = function(spectrum = NULL,counts = NULL){
if(is.null(spectrum) & is.null(counts)){
stop("no data")
}
list(VAF = spectrum,counts = counts)
}
x = init(counts = counts)
x
setwd("~/Documents/GitHub/ProjectPepi")
fit_counts = function(x,path_to_model,cmdstan_path,
ndraws = 1000,init = NULL,seed = 45, alpha_ln = 1.5,
beta_ln = 1, alpha_lp = 1.5, beta_lp = 1, alpha_rn = 1, beta_rn = 10,
alpha_rp = 1, beta_rp = 10
){
dir.create(path_to_model)
cmdstanr::set_cmdstan_path(cmdstan_path)
if(is.null(x$counts)){
stop("no cell counts")
}
model = counts_inference_code(likelihood = T)
if(! "regressionODE.stan" %in% list.files(path_to_model)){
write_stan_file(
model,
dir = ".",
basename = paste0(path_to_model,"/regressionODE.stan"),
force_overwrite = FALSE,
hash_salt = ""
)
}
t0 = counts$time %>% min()
z0n = counts %>% filter(time == t0,epistate == "-") %>% pull(counts)
z0p = counts %>% filter(time == t0,epistate == "+") %>% pull(counts)
data  = list(
n_times = counts %>% filter(time > t0) %>% pull(time) %>% unique(),
z0 = c(z0n,z0p,0,0,0),
t0 = t0,
zminus = counts %>% filter(time > t0, epistate = "-") %>% pull(counts),
zplus = counts %>% filter(time > t0, epistate == "+") %>% pull(counts),
t = counts %>% filter(time > 0) %>% pull(time) %>% unique(),
alpha_ln = alpha_ln,
beta_ln = beta_ln,
alpha_lp = alpha_lp,
beta_lp = beta_lp,
alpha_rn = alpha_rn,
beta_rn = beta_rn,
alpha_rp = alpha_rp,
beta_rp = beta_rp
)
file = paste0(path_to_model,"/regressionODE.stan")
mod = cmdstan_model(file)
fit = mod$variational(data = data, seed = seed,
init = init,
output_samples = ndraws,
algorithm="fullrank")
x$inference$counts = fit
x$stan_data$counts = data
return(x)
}
x
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/opt/anaconda3/envs/stan/bin/cmdstan/",
ndraws = 1000,init = NULL,seed = 45, alpha_ln = 1.5,
beta_ln = 1, alpha_lp = 1.5, beta_lp = 1, alpha_rn = 1, beta_rn = 10,
alpha_rp = 1, beta_rp = 10)
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/opt/anaconda3/envs/stan/bin/cmdstan/",
ndraws = 1000,init = NULL,seed = 45, alpha_ln = 1.5,
beta_ln = 1, alpha_lp = 1.5, beta_lp = 1, alpha_rn = 1, beta_rn = 10,
alpha_rp = 1, beta_rp = 10)
fit_counts = function(x,path_to_model,cmdstan_path,
ndraws = 1000,init = NULL,seed = 45, alpha_ln = 1.5,
beta_ln = 1, alpha_lp = 1.5, beta_lp = 1, alpha_rn = 1, beta_rn = 10,
alpha_rp = 1, beta_rp = 10
){
dir.create(path_to_model)
cmdstanr::set_cmdstan_path(cmdstan_path)
if(is.null(x$counts)){
stop("no cell counts")
}
model = counts_inference_code(likelihood = T)
if(! "regressionODE.stan" %in% list.files(path_to_model)){
write_stan_file(
model,
dir = ".",
basename = paste0(path_to_model,"/regressionODE.stan"),
force_overwrite = FALSE,
hash_salt = ""
)
}
t0 = counts$time %>% min()
z0n = counts %>% filter(time == t0,epistate == "-") %>% pull(counts)
z0p = counts %>% filter(time == t0,epistate == "+") %>% pull(counts)
data  = list(
n_times = counts %>% filter(time > t0) %>% pull(time) %>% unique(),
z0 = c(z0n,z0p,0,0,0),
t0 = t0,
zminus = counts %>% filter(time > t0, epistate == "-") %>% pull(counts),
zplus = counts %>% filter(time > t0, epistate == "+") %>% pull(counts),
t = counts %>% filter(time > 0) %>% pull(time) %>% unique(),
alpha_ln = alpha_ln,
beta_ln = beta_ln,
alpha_lp = alpha_lp,
beta_lp = beta_lp,
alpha_rn = alpha_rn,
beta_rn = beta_rn,
alpha_rp = alpha_rp,
beta_rp = beta_rp
)
file = paste0(path_to_model,"/regressionODE.stan")
mod = cmdstan_model(file)
fit = mod$variational(data = data, seed = seed,
init = init,
output_samples = ndraws,
algorithm="fullrank")
x$inference$counts = fit
x$stan_data$counts = data
return(x)
}
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/opt/anaconda3/envs/stan/bin/cmdstan/",
ndraws = 1000,init = NULL,seed = 45, alpha_ln = 1.5,
beta_ln = 1, alpha_lp = 1.5, beta_lp = 1, alpha_rn = 1, beta_rn = 10,
alpha_rp = 1, beta_rp = 10)
dir.create(path_to_model)
cmdstanr::set_cmdstan_path(cmdstan_path)
cmdstan_path = "/opt/anaconda3/envs/stan/bin/cmdstan/"
cmdstanr::set_cmdstan_path(cmdstan_path)
if(is.null(x$counts)){
stop("no cell counts")
}
model = counts_inference_code(likelihood = T)
if(! "regressionODE.stan" %in% list.files(path_to_model)){
write_stan_file(
model,
dir = ".",
basename = paste0(path_to_model,"/regressionODE.stan"),
force_overwrite = FALSE,
hash_salt = ""
)
}
! "regressionODE.stan" %in% list.files(path_to_model)
t0 = counts$time %>% min()
z0n = counts %>% filter(time == t0,epistate == "-") %>% pull(counts)
z0p = counts %>% filter(time == t0,epistate == "+") %>% pull(counts)
data  = list(
n_times = counts %>% filter(time > t0) %>% pull(time) %>% unique(),
z0 = c(z0n,z0p,0,0,0),
t0 = t0,
zminus = counts %>% filter(time > t0, epistate == "-") %>% pull(counts),
zplus = counts %>% filter(time > t0, epistate == "+") %>% pull(counts),
t = counts %>% filter(time > 0) %>% pull(time) %>% unique(),
alpha_ln = alpha_ln,
beta_ln = beta_ln,
alpha_lp = alpha_lp,
beta_lp = beta_lp,
alpha_rn = alpha_rn,
beta_rn = beta_rn,
alpha_rp = alpha_rp,
beta_rp = beta_rp
)
alpha_ln = 1.5
beta_ln = 1
alpha_lp = 1.5
beta_lp = 1
alpha_rn = 1
beta_rn = 10
alpha_rp = 1
beta_rp = 10
t0 = counts$time %>% min()
z0n = counts %>% filter(time == t0,epistate == "-") %>% pull(counts)
z0p = counts %>% filter(time == t0,epistate == "+") %>% pull(counts)
data  = list(
n_times = counts %>% filter(time > t0) %>% pull(time) %>% unique(),
z0 = c(z0n,z0p,0,0,0),
t0 = t0,
zminus = counts %>% filter(time > t0, epistate == "-") %>% pull(counts),
zplus = counts %>% filter(time > t0, epistate == "+") %>% pull(counts),
t = counts %>% filter(time > 0) %>% pull(time) %>% unique(),
alpha_ln = alpha_ln,
beta_ln = beta_ln,
alpha_lp = alpha_lp,
beta_lp = beta_lp,
alpha_rn = alpha_rn,
beta_rn = beta_rn,
alpha_rp = alpha_rp,
beta_rp = beta_rp
)
file = paste0(path_to_model,"/regressionODE.stan")
mod = cmdstan_model(file)
fit = mod$variational(data = data, seed = seed,
init = init,
output_samples = ndraws,
algorithm="fullrank")
ndraws = 1000
seed = 45
fit = mod$variational(data = data, seed = seed,
init = init,
output_samples = ndraws,
algorithm="fullrank")
init = NULL
fit = mod$variational(data = data, seed = seed,
init = init,
output_samples = ndraws,
algorithm="fullrank")
counts %>% filter(time > t0) %>% pull(time) %>% unique() %>% length()
counts
t0 = counts$time %>% min()
z0n = counts %>% filter(time == t0,epistate == "-") %>% pull(counts)
z0p = counts %>% filter(time == t0,epistate == "+") %>% pull(counts)
data  = list(
n_times = counts %>% filter(time > t0) %>% pull(time) %>% unique() %>% length(),
z0 = c(z0n,z0p,0,0,0),
t0 = t0,
zminus = counts %>% filter(time > t0, epistate == "-") %>% pull(counts),
zplus = counts %>% filter(time > t0, epistate == "+") %>% pull(counts),
t = counts %>% filter(time > 0) %>% pull(time) %>% unique(),
alpha_ln = alpha_ln,
beta_ln = beta_ln,
alpha_lp = alpha_lp,
beta_lp = beta_lp,
alpha_rn = alpha_rn,
beta_rn = beta_rn,
alpha_rp = alpha_rp,
beta_rp = beta_rp
)
file = paste0(path_to_model,"/regressionODE.stan")
mod = cmdstan_model(file)
fit = mod$variational(data = data, seed = seed,
init = init,
output_samples = ndraws,
algorithm="fullrank")
t0
counts %>% filter(time > t0, epistate == "-") %>% pull(counts)
counts %>% filter(time > t0, epistate == "-") %>% pull(counts) %>% length()
counts %>% filter(time > t0) %>% pull(time) %>% unique() %>% length()
c(z0n,z0p,0,0,0)
counts %>% filter(time > t0, epistate == "+") %>% pull(counts)
counts %>% filter(time > t0, epistate == "+") %>% pull(counts) %>% length()
counts %>% filter(time > 0) %>% pull(time) %>% unique()
counts %>% filter(time > 0) %>% pull(time) %>% unique() %>% length()
data  = list(
n_times = counts %>% filter(time > t0) %>% pull(time) %>% unique() %>% length(),
z0 = c(z0n,z0p,0,0,0),
t0 = t0,
zminus = counts %>% filter(time > t0, epistate == "-") %>% pull(counts),
zplus = counts %>% filter(time > t0, epistate == "+") %>% pull(counts),
t = counts %>% filter(time > 0) %>% pull(time) %>% unique(),
alpha_ln = alpha_ln,
beta_ln = beta_ln,
alpha_lp = alpha_lp,
beta_lp = beta_lp,
alpha_rn = alpha_rn,
beta_rn = beta_rn,
alpha_rp = alpha_rp,
beta_rp = beta_rp
)
data
file = paste0(path_to_model,"/regressionODE.stan")
paste0(path_to_model,"/regressionODE.stan")
mod = cmdstan_model(file)
fit = mod$variational(data = data, seed = seed,
init = init,
output_samples = ndraws,
algorithm="fullrank")
source("~/Documents/GitHub/ProjectPepi/R/stan_generating_code.R")
model = counts_inference_code(likelihood = T)
write_stan_file(
model,
dir = ".",
basename = paste0(path_to_model,"/regressionODE.stan"),
force_overwrite = FALSE,
hash_salt = ""
)
t0 = counts$time %>% min()
z0n = counts %>% filter(time == t0,epistate == "-") %>% pull(counts)
z0p = counts %>% filter(time == t0,epistate == "+") %>% pull(counts)
data  = list(
n_times = counts %>% filter(time > t0) %>% pull(time) %>% unique() %>% length(),
z0 = c(z0n,z0p,0,0,0),
t0 = t0,
zminus = counts %>% filter(time > t0, epistate == "-") %>% pull(counts),
zplus = counts %>% filter(time > t0, epistate == "+") %>% pull(counts),
t = counts %>% filter(time > 0) %>% pull(time) %>% unique(),
alpha_ln = alpha_ln,
beta_ln = beta_ln,
alpha_lp = alpha_lp,
beta_lp = beta_lp,
alpha_rn = alpha_rn,
beta_rn = beta_rn,
alpha_rp = alpha_rp,
beta_rp = beta_rp
)
file = paste0(path_to_model,"/regressionODE.stan")
mod = cmdstan_model(file)
fit = mod$variational(data = data, seed = seed,
init = init,
output_samples = ndraws,
algorithm="fullrank")
fit
x
x = init(counts = counts)
init = function(spectrum = NULL,counts = NULL){
if(is.null(spectrum) & is.null(counts)){
stop("no data")
}
list(VAF = spectrum,counts = counts)
}
x = init(counts = counts)
x
x$inference$counts = fit
x$stan_data$counts = data
x
x$inference$counts
fit = x
fit
names(x$inference)
tree <- readRDS("~/Dropbox/stick-breaking/variational/depth_2/standard_case/tree.rds")
tree
tree %>%
mutate(w_plus  = "", w_minus = "") %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & leave)) %>%
filter(!(variable == "nu" & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") &
substr(x = variable,start = nchar(node),stop = nchar(node)) == "p")) %>%
mutate(variable = paste0(variable,"_",node)) %>% pull(variable)
tree = tree %>% mutate(leave = ifelse(!paste0(node,"n") %in% nodes,T,F))
nodes = tree %>% pull(node)
tree %>%
mutate(w_plus  = "", w_minus = "") %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & leave)) %>%
filter(!(variable == "nu" & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") &
substr(x = variable,start = nchar(node),stop = nchar(node)) == "p")) %>%
mutate(variable = paste0(variable,"_",node)) %>% pull(variable)
tree = tree %>% mutate(node = gsub(x = node,pattern = "-",replacement = "n")) %>%
mutate(node = gsub(x = node,pattern = "\\+",replacement = "p"))
tree = tree %>% mutate(leave = ifelse(!paste0(node,"n") %in% nodes,T,F))
nodes = tree %>% pull(node)
tree %>%
mutate(w_plus  = "", w_minus = "") %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & leave)) %>%
filter(!(variable == "nu" & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") &
substr(x = variable,start = nchar(node),stop = nchar(node)) == "p")) %>%
mutate(variable = paste0(variable,"_",node)) %>% pull(variable)
tree %>%
mutate(w_plus  = "", w_minus = "") %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & leave)) %>%
filter(!(variable == "nu" & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") &
substr(x = variable,start = nchar(node),stop = nchar(node)) == "p"),
! variable %in% c("level","s","delta","rate","tail","ccf_minus","ccf_plus")) %>%
mutate(variable = paste0(variable,"_",node)) %>% pull(variable)
tree
tree = tree %>% mutate(node = gsub(x = node,pattern = "-",replacement = "n")) %>%
mutate(node = gsub(x = node,pattern = "\\+",replacement = "p"))
tree
tree %>% mutate(leave = ifelse(!paste0(node,"n") %in% nodes,T,F))
tree = tree %>% mutate(leave = ifelse(!paste0(node,"n") %in% nodes,T,F))
nodes = tree %>% pull(node)
tree %>%
mutate(w_plus  = "", w_minus = "") %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & leave)) %>%
filter(!(variable == "nu" & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") &
substr(x = variable,start = nchar(node),stop = nchar(node)) == "p"),
! variable %in% c("level","s","delta","rate","tail","ccf_minus","ccf_plus")) %>%
mutate(variable = paste0(variable,"_",node)) %>% pull(variable)
tree %>%
mutate(w_plus  = "", w_minus = "") %>% reshape2::melt()
tree %>%
mutate(w_plus  = "", w_minus = "") %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & leave)) %>%
filter(!(variable == "nu" & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") &
substr(x = node,start = nchar(node),stop = nchar(node)) == "p"),
! variable %in% c("level","s","delta_t","rate","tail","ccf_minus","ccf_plus")) %>%
mutate(variable = paste0(variable,"_",node)) %>% pull(variable)
tree %>%
mutate(w_plus  = 0.5, w_minus = 0.5) %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & leave)) %>%
filter(!(variable == "nu" & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") &
substr(x = node,start = nchar(node),stop = nchar(node)) == "p"),
! variable %in% c("level","s","delta_t","rate","tail","ccf_minus","ccf_plus")) %>%
mutate(variable = paste0(variable,"_",node)) %>% pull(variable)
tree %>%
mutate(w_plus  = 0.5, w_minus = 0.5) %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & leave)) %>%
filter(!(variable == "nu" & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") & leave)) %>%
filter(!(variable %in% c("w_minus","w_plus") &
substr(x = node,start = nchar(node),stop = nchar(node)) == "p"),
!(node == "n" & variable %in% c("phi","w_minus","w_plus","p_switch")),
! variable %in% c("level","s","delta_t","rate","tail","ccf_minus","ccf_plus")) %>%
mutate(variable = paste0(variable,"_",node)) %>% pull(variable)
