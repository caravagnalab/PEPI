max_depth = max_depth)
if(tail){
tree = add_tail_muts(tree = tree,mu = hypers$mu,len = hypers$len,vaf_min = vaf_min)
}
dist = calculate_distance(tree,data,vaf_min = vaf_min,
threshold = switch_threshold,tail = tail)
Np = Np + 1
}
print(paste0("particle ",i))
return(tibble(tree = list(tree), n = i, w = 1, dist = dist,
Ne = 1/Np,
# Ne = 1/(1 + exp(-k*(dist/dist_max - 1))),
eps = dist_max))
},
PARAMS = lapply(1:N_sampling,list),
parallel = parallel,
filter_errors = F,
export = ls(globalenv()),
packages = packages) %>% bind_rows()
parallel
parallel = T
tot = max(particles$w) + log(sum(exp(particles$w - max(particles$w))))
particles$w = exp(particles$w - tot)
posterior = list(particles)
input$posterior = posterior
delta_dist  = input$dist_max - particles %>% pull(dist) %>% median()
print(paste0("updated dist: ", particles %>% pull(dist) %>% median()))
delta_dist
input$dist_max
particles %>% pull(dist) %>% median()
delta_dist  = input$dist_max - particles %>% pull(dist) %>% median()
print(paste0("updated dist: ", particles %>% pull(dist) %>% median()))
print(paste0("delta dist: ", delta_dist))
input$dist_max = particles %>% pull(dist) %>% median()
t = 2
input$t = t
input
print(paste0("iteration ",t))
sigmas = get_sigmas(particles,max_depth)
input$sigmas = sigmas
particles = easypar::run(FUN = function(i){
source(paste0(path_lib,"/stick-breaking/R/generative_model.R"))
source(paste0(path_lib,"/stick-breaking/R/ABC_functions.R"))
data = input$data
hypers = input$hypers
M = input$M
max_depth = input$max_depth
switch_threshold = input$switch_threshold
tail = input$tail
dist_max = input$dist_max
vaf_min = input$vaf_min
posterior = input$posterior
sigmas = input$sigmas
t = input$t
# k = input$k
Np = 0
dist = dist_max + 1
while(dist > dist_max){
tree =  particle_sampling(M,hypers,particles = posterior[[t-1]],sigmas,
max_depth = max_depth)
if(tail){
tree = add_tail_muts(tree = tree,mu = hypers$mu,len = hypers$len,
vaf_min = vaf_min)
}
dist = calculate_distance(tree,data,vaf_min = vaf_min,
threshold = switch_threshold,tail = tail)
Np = Np + 1
}
print(paste0("particle ",i))
w = get_weigths(tree,posterior[[t-1]],sigmas,hypers,
max_depth,switch_threshold)
return(tibble(tree = list(tree), n = i, w = w, dist = dist,
Ne = 1/Np,
# Ne = 1/(1 + exp(-k*(dist/dist_max - 1)))),
eps = dist_max
))
},
PARAMS = lapply(1:N_sampling,list),
parallel = parallel,
filter_errors = F,
export = ls(globalenv()),
packages = packages) %>% bind_rows()
tot = max(particles$w) + log(sum(exp(particles$w - max(particles$w))))
particles$w = exp(particles$w - tot)
posterior[[t]] = particles
input$posterior = posterior
delta_dist  = input$dist_max - particles %>% pull(dist) %>% median()
print(paste0("updated dist: ", particles %>% pull(dist) %>% median()))
print(paste0("delta dist: ", delta_dist))
input$dist_max = particles %>% pull(dist) %>% median()
t = t + 1
input$t = t
input
input$dist_max
particles
tot = max(particles$w) + log(sum(exp(particles$w - max(particles$w))))
particles$w = exp(particles$w - tot)
posterior[[t]] = particles
posterior
posterior[[3]] = NULL
posterior
tot = max(particles$w) + log(sum(exp(particles$w - max(particles$w))))
particles$w = exp(particles$w - tot)
posterior[[2]] = particles
input$posterior = posterior
posterior
delta_dist  = input$dist_max - particles %>% pull(dist) %>% median()
print(paste0("updated dist: ", particles %>% pull(dist) %>% median()))
print(paste0("delta dist: ", delta_dist))
input$dist_max = 0.391
particles %>% pull(dist) %>% median()
input$dist_max
delta_dist  = input$dist_max - particles %>% pull(dist) %>% median()
print(paste0("updated dist: ", particles %>% pull(dist) %>% median()))
print(paste0("delta dist: ", delta_dist))
input$dist_max = particles %>% pull(dist) %>% median()
t = t + 1
input$t = t
input
source('~/Dropbox/stick-breaking/R/ABC_functions.R')
data = spectrum
start.time <- Sys.time()
post = ABC(data,hypers,N_sampling = 10,path_lib = "~/Dropbox",
dist_max = 1, delta_min = 1e-3, max_time = 10, max_depth=2,
switch_threshold = 0.1,
vaf_min = 0.05,
tail = F,
parallel = T)
end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken
source('~/Dropbox/stick-breaking/R/ABC_functions.R')
source('~/Dropbox/stick-breaking/R/ABC_functions.R')
install.packages("Signac")
# gR = import("NPC_A_tn5.bed", format="bed")
#
# x = reduce(resize(gR, width(gR + 1), "start"))
library(Signac)
# gR = import("NPC_A_tn5.bed", format="bed")
#
# x = reduce(resize(gR, width(gR + 1), "start"))
install.packages("Signac")
library(Signac)
genome <- 780007
names(genome) <- 'chr1'
fpath <- "fragments_mdanderson.tgz"
fragments <- CreateFragmentObject(fpath)
setwd("~/Dropbox/scGETseq_Data/fragments/fragments_mdanderson")
fpath <- "fragments_mdanderson.tgz"
fragments <- CreateFragmentObject(fpath)
devtools::install_github("Caravagnalab/Rraces")
devtools::install_github("Caravagnalab/Rraces")
devtools::install_github("Caravagnalab/Rraces")
pkgbuild::check_build_tools(debug = TRUE)
devtools::install_github("Caravagnalab/Rraces")
devtools::install_github("Caravagnalab/Rraces")
setwd("~/")
devtools::load_all("rRACES")
install.packages(c("anndata", "Seurat"))
library(rstan)
library(dplyr)
updateR()
installr()
require(installr)
library(Pepi)
setwd("~/Documents/GitHub")
setwd("~/Documents/GitHub/ProjectPepi")
devtools::load_all()
library(Pepi)
M = 8000
mu = 10^-7
length = 2.7*10^9
s = 0.25
rate_minus = 1/7000
rate_plus = 1/8000
max_depth = 3
at = 10
bt = 80
gamma = 100
tree = generate_nodes(M = M,gamma = gamma,at=at,bt=bt,s = s,
rate_minus=rate_minus,rate_plus=rate_plus,mu,length,
max_depth = max_depth)
M = 8000
mu = 10^-7
length = 2.7*10^9
s = 0.25
rate_minus = 1/7000
rate_plus = 1/8000
max_depth = 3
at = 10
bt = 80
gamma = 100
library(dplyr)
tree = generate_nodes(M = M,gamma = gamma,at=at,bt=bt,s = s,
rate_minus=rate_minus,rate_plus=rate_plus,mu,length,
max_depth = max_depth)
tree
threshold = 0.1
tree = filter_nodes(tree,threshold = threshold)
tree = calculate_ccf(tree,s)
tree
tree = add_tail_muts(mu = mu,tree = tree,vaf_min = 0.05)
spectrum = generate_spectrum(tree,vaf_min = 0.05,DP = 200,tail = F)
spectrum = spectrum %>% mutate(VAFx = Nx/DPx,VAFy = Ny/DPy)
source('~/Documents/GitHub/ProjectPepi/R/plot_functions.R')
source('~/Documents/GitHub/ProjectPepi/R/plot_functions.R')
tree = calculate_ccf(tree,s)
tree
tree = add_tail_muts(mu = mu,tree = tree,vaf_min = 0.05)
spectrum = generate_spectrum(tree,vaf_min = 0.05,DP = 200,tail = F)
spectrum = spectrum %>% mutate(VAFx = Nx/DPx,VAFy = Ny/DPy)
p1 = plot_multivariate(spectrum)
p2 = plot_tree(tree)
p3 = plot_marginal(spectrum)
library(rstan)
library(cmdstanr)
library(dplyr)
library(MCMCprecision)
library(VGAM)
library(ggplot2)
library(ape)
library(ggtree)
library(treeio)
library(ggpubr)
library(parallel)
tree = calculate_ccf(tree,s)
tree = calculate_ccf(tree,s)
tree
tree = add_tail_muts(mu = mu,tree = tree,vaf_min = 0.05)
spectrum = generate_spectrum(tree,vaf_min = 0.05,DP = 200,tail = F)
spectrum = spectrum %>% mutate(VAFx = Nx/DPx,VAFy = Ny/DPy)
p1 = plot_multivariate(spectrum)
p2 = plot_tree(tree)
p = ggarrange(plotlist = list(p1,p2),ncol = 2,nrow = 1)
p = ggarrange(plotlist = list(p1,p2),ncol = 2,nrow = 1)
p = ggarrange(plotlist = list(p,p3),ncol = 1,nrow = 2)
p3 = plot_marginal(spectrum)
p = ggarrange(plotlist = list(p1,p2),ncol = 2,nrow = 1)
p = ggarrange(plotlist = list(p,p3),ncol = 1,nrow = 2)
p
x = init_vaf(data = spectrum)
print(x)
x = fit_tree(x,path_to_model = "models",
cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
max_depth = 3,ndraws = 1000,
init = list(list(rn = 1/6000,rp = 1/9000)), seed = 50,
mu = 1e-7,l = 2.7*10^9,rho_n = 1,rho_p = 1,nu_t = 0.1,
qt = 1e4,rate_n = 1e-4,qn = 1e3,rate_p = 1e-4,
qp = 1e3,k = 1e4,gamma = 200)
x$inference$tree$cmdstan_summary()
tree
get_average_tree(x,threshold = 0.1)
tree
x = get_average_tree(x,threshold = 0.1)
x = get_average_tree(x,threshold = 0.1)
x$inferred_tree
x = get_clusters(x)
p1 = plot_multivariate(x$VAF)
p2 = plot_tree(x$inferred_tree)
p = ggarrange(plotlist = list(p1,p2),ncol = 2,nrow = 1)
p = ggarrange(plotlist = list(p,p3),ncol = 1,nrow = 2)
p
x = fit_s(x,path_to_model = "models",
cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
threshold = 0.1,
ndraws = 1000,init = NULL,seed = 250,
mu = 1e-7,l = 2.7*10^9,ms = -1.8, sigma = 0.7, k = 1e3)
x$inference$fitness$cmdstan_summary()
x = get_posterior(x)
x
fit = x
fit
"tree" %in% names(fit$inference)
!"inferred_tree" %in% names(fit)
fit
usethis::use_data(fit)
load("~/Documents/GitHub/ProjectPepi/data/fit.rda")
fit
fit$inference$tree$data_file()
x = fit
x
x = fit$inference$tree
tree = fit$inferred_tree
x
tree
tree = tree %>% mutate(node = gsub(x = node,pattern = "-",replacement = "n")) %>%
mutate(node = gsub(x = node,pattern = "\\+",replacement = "p"))
tree = tree %>% mutate(leave = ifelse(!paste0(node,"n") %in% nodes,T,F))
tree
tree %>% mutate(node = gsub(x = node,pattern = "-",replacement = "n")) %>%
mutate(node = gsub(x = node,pattern = "\\+",replacement = "p"))
tree %>% mutate(leave = ifelse(!paste0(node,"n") %in% nodes,T,F))
source('~/Documents/GitHub/ProjectPepi/R/getters.R')
x = get_posterior(x)
plot_inference(x,params = c("rn","rp","s"))
load("~/Documents/GitHub/ProjectPepi/data/fit_vaf.rda")
x = fit
x
x = get_posterior(x)
x$posterior
plot_inference(x,params = c("rn","rp","s"))
setwd("~/Documents/GitHub/ProjectPepi")
devtools::load_all()
data("Counts")
counts
data("Counts")
Counts
counts
data("Counts")
counts
x = init_counts(counts)
x
x$counts
x
x
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = NULL,seed = 145, alpha_ln = 1,
beta_ln = 1, alpha_lp = 1.5, beta_lp = 1, alpha_rn = 1, beta_rn = 10,
alpha_rp = 1, beta_rp = 10)
x$inference$counts$cmdstan_summary()
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = NULL,seed = 45, alpha_ln = 10,
beta_ln = 10, alpha_lp = 150, beta_lp = 10, alpha_rn = 10, beta_rn = 100,
alpha_rp = 10, beta_rp = 100)
x
x$inference$counts$cmdstan_summary()
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = NULL,seed = 1245, alpha_ln = 10,
beta_ln = 10, alpha_lp = 150, beta_lp = 10, alpha_rn = 10, beta_rn = 20,
alpha_rp = 10, beta_rp = 20)
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = NULL,seed = 1245, alpha_ln = 10,
beta_ln = 10, alpha_lp = 150, beta_lp = 10, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = NULL,seed = 12, alpha_ln = 150,
beta_ln = 100, alpha_lp = 150, beta_lp = 100, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x$inference$counts$cmdstan_summary()
x$counts
x$counts %>% View()
658585/10^5
1063090/10^5
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = NULL,seed = 112, alpha_ln = 100,
beta_ln = 100, alpha_lp = 150, beta_lp = 100, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x$inference$counts$cmdstan_summary()
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = list(list(lambda_minus = 0.8,lambda_plus = 2)),
seed = 118, alpha_ln = 10,
beta_ln = 10, alpha_lp = 15, beta_lp = 10, alpha_rn = 10, beta_rn = 20,
alpha_rp = 10, beta_rp = 20)
x$inference$counts$cmdstan_summary()
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = list(list(lambda_minus = 0.8,lambda_plus = 2)),
seed = 118, alpha_ln = 100,
beta_ln = 100, alpha_lp = 150, beta_lp = 100, alpha_rn = 10, beta_rn = 20,
alpha_rp = 10, beta_rp = 20)
x$inference$counts$cmdstan_summary()
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = list(list(lambda_minus = 1.5,lambda_plus = 1.5)),
seed = 120, alpha_ln = 100,
beta_ln = 100, alpha_lp = 150, beta_lp = 100, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x$inference$counts$cmdstan_summary()
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = list(list(lambda_minus = 2,lambda_plus = 2,
effective_switch_rate_n = 0.7,  effective_switch_rate_n = 0.8)),
seed = 120, alpha_ln = 100,
beta_ln = 100, alpha_lp = 150, beta_lp = 100, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = list(list(lambda_minus = 2,lambda_plus = 2,
effective_switch_rate_n = 0.7,  effective_switch_rate_p = 0.8)),
seed = 125, alpha_ln = 100,
beta_ln = 100, alpha_lp = 150, beta_lp = 100, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x$inference$counts$cmdstan_summary()
(10^6-5*10^5)/10**5
(10^6-5*10^5)/(5*10**5)
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = list(list(lambda_minus = 2,lambda_plus = 2,
effective_switch_rate_n = 0.7,  effective_switch_rate_p = 0.8)),
seed = 155, alpha_ln = 200,
beta_ln = 100, alpha_lp = 200, beta_lp = 100, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x$inference$counts$cmdstan_summary()
x = get_average_counts(x)
x$predicted_counts
plot_counts(x)
load("~/Documents/GitHub/ProjectPepi/data/fit_vaf.rda")
x
source('~/Documents/GitHub/ProjectPepi/R/getters.R')
x = get_posterior(x)
plot_inference(x,params = c("lambda_minus","lambda_plus","effective_switching_rate_n","effective_switching_rate_p"))
x$posterior$counts %>% colnames()
plot_inference(x,params = c("lambda_minus","lambda_plus","effective_switch_rate_n","effective_switch_rate_p"))
x = get_average_counts(x)
plot_counts(x)
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = list(list(lambda_minus = 1.5,lambda_plus = 3,
effective_switch_rate_n = 0.7,  effective_switch_rate_p = 0.8)),
seed = 185, alpha_ln = 200,
beta_ln = 100, alpha_lp = 200, beta_lp = 100, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = list(list(lambda_minus = 1.5,lambda_plus = 3,
effective_switch_rate_n = 0.7,  effective_switch_rate_p = 0.8)),
seed = 185, alpha_ln = 200,
beta_ln = 100, alpha_lp = 200, beta_lp = 100, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x
x$inference$counts$cmdstan_summary()
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = list(list(lambda_minus = 1,lambda_plus = 3,
effective_switch_rate_n = 0.7,  effective_switch_rate_p = 0.8)),
seed = 195, alpha_ln = 150,
beta_ln = 100, alpha_lp = 200, beta_lp = 100, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x$inference$counts$cmdstan_summary()
x = get_average_counts(x)
plot_counts(x)
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = list(list(lambda_minus = 1,lambda_plus = 5,
effective_switch_rate_n = 0.7,  effective_switch_rate_p = 0.8)),
seed = 205, alpha_ln = 150,
beta_ln = 100, alpha_lp = 200, beta_lp = 100, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x
x$inference$counts$cmdstan_summary()
x = get_average_counts(x)
plot_counts(x)
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = list(list(lambda_minus = 1,lambda_plus = 5,
effective_switch_rate_n = 0.7,  effective_switch_rate_p = 0.8)),
seed = 805, alpha_ln = 150,
beta_ln = 100, alpha_lp = 250, beta_lp = 100, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x$inference$counts$cmdstan_summary()
x = get_average_counts(x)
plot_counts(x)
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = list(list(lambda_minus = 1,lambda_plus = 4,
effective_switch_rate_n = 0.7,  effective_switch_rate_p = 0.8)),
seed = 215, alpha_ln = 150,
beta_ln = 100, alpha_lp = 220, beta_lp = 100, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x$inference$counts$cmdstan_summary()
x = get_average_counts(x)
plot_counts(x)
x = get_posterior(x)
plot_inference(x,params = c("lambda_minus","lambda_plus","effective_switch_rate_n","effective_switch_rate_p"))
x
plot_counts(x)
plot_counts(x)
x
x = get_average_counts(x)
plot_counts(x)
x = get_average_counts(x)
plot_counts(x)
x$inference$counts$cmdstan_summary()
plot_counts(x)
x
x = get_average_counts(x)
plot_counts(x)
x = get_average_counts(x)
plot_counts(x)
x = get_average_counts(x)
plot_counts(x)
x = get_average_counts(x)
plot_counts(x)
x = get_average_counts(x)
plot_counts(x)
x = get_average_counts(x)
plot_counts(x)
x
plot_counts(x)
library(Pepi)
data("Counts")
counts
x = init_counts(counts)
x
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = list(list(lambda_minus = 1,lambda_plus = 4,
effective_switch_rate_n = 0.7,  effective_switch_rate_p = 0.8)),
seed = 215, alpha_ln = 150,
beta_ln = 100, alpha_lp = 220, beta_lp = 100, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x = fit_counts(x,path_to_model = "models",cmdstan_path = "/.cmdstan/cmdstan-2.33.1",
ndraws = 1000,init = list(list(lambda_minus = 1,lambda_plus = 4,
effective_switch_rate_n = 0.7,  effective_switch_rate_p = 0.8)),
seed = 215, alpha_ln = 150,
beta_ln = 100, alpha_lp = 220, beta_lp = 100, alpha_rn = 100, beta_rn = 200,
alpha_rp = 100, beta_rp = 200)
x
x = get_average_counts(x)
plot_counts(x)
x = get_posterior(x)
plot_inference(x,params = c("lambda_minus","lambda_plus","effective_switch_rate_n","effective_switch_rate_p"))
source('~/Documents/GitHub/ProjectPepi/R/plot_functions.R')
CNAqc:::my_ggplot_theme()
CNAqc:::my_ggplot_theme()
devtools::document()
devtools::document()
x
usethis::use_data(x)
setwd("~/Documents/GitHub/ProjectPepi")
pkgdown::build_site()
`$stdout`
pkgdown::build_site()
usethis::use_pkgdown()
