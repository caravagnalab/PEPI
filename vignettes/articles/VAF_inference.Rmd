---
title: "VAF analisys"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(PEPI)
library(rstan)
library(cmdstanr)
library(dplyr)
library(MCMCprecision)
library(VGAM)
library(ggplot2)
library(ape)
library(ggtree)
library(treeio)
library(ggpubr)
library(parallel)
```

We generate a sample tree encoding epigenetic states and number of mutations of branches

```{r}

set.seed(1908)
M = 8000
mu = 10^-7
length = 2.7*10^9
s = 0.25
rate_minus = 1/7000
rate_plus = 1/8000
max_depth = 3
at = 10
bt = 80
gamma = 100

tree = generate_nodes(M = M,gamma = gamma,at=at,bt=bt,s = s,
                      rate_minus=rate_minus,rate_plus=rate_plus,mu,length,
                      max_depth = max_depth)
tree

threshold = 0.1
tree = filter_nodes(tree,threshold = threshold)

tree = calculate_ccf(tree,s)
tree

tree = add_tail_muts(mu = mu,tree = tree,vaf_min = 0.05)
spectrum = generate_spectrum(tree,vaf_min = 0.05,DP = 200,tail = F)
spectrum = spectrum %>% mutate(VAFx = Nx/DPx,VAFy = Ny/DPy)

p1 = plot_multivariate(spectrum)
p2 = plot_tree(tree)
p3 = plot_marginal(spectrum)

p = ggarrange(plotlist = list(p1,p2),ncol = 2,nrow = 1) 
p = ggarrange(plotlist = list(p,p3),ncol = 1,nrow = 2) 
p

```


We infer the sample tree and epimutation rates. We start by creating a PEPI VAF object

```{r}

x = init_vaf(data = spectrum)
print(x)
```

We infer epimutation rates and cluster centroids
```{r}

x = fit_tree(x,path_to_model = "models",
              cmdstan_path = "/opt/anaconda3/envs/stan/bin/cmdstan/",
                    max_depth = 3,ndraws = 1000,
                    init = list(list(rn = 1/5000,rp = 1/9000)), seed = 690,
                    mu = 1e-7,l = 2.7*10^9,rho_n = 1,rho_p = 1,nu_t = 0.1,
                    qt = 1e4,rate_n = 1/5000,qn = 1e4,rate_p = 1e-4,
                    qp = 1e4,k = 1e4,gamma = 150)

```

We obtain the inferred tree 
```{r}

x = get_average_tree(x,threshold = 0.1)
x$inferred_tree
```

We get the cluster of mutations

```{r}

x = get_clusters(x)

```

We plot the distributions and inferred tree
```{r}

p1 = plot_multivariate(x$VAF)
p2 = plot_tree(x$inferred_tree)
p3 = plot_marginal(x$VAF)

p = ggarrange(plotlist = list(p1,p2),ncol = 2,nrow = 1) 
p = ggarrange(plotlist = list(p,p3),ncol = 1,nrow = 2) 
p
```



We infer s and epimutation clocks
```{r}

x = fit_s(x,path_to_model = "models",
          cmdstan_path = "/opt/anaconda3/envs/stan/bin/cmdstan/",
          threshold = 0.1,
          ndraws = 1000,init = NULL,seed = 250,
          mu = 1e-7,l = 2.7*10^9,ms = -1.8, sigma = 0.7, k = 1e3)
```


We plot the inferred distributions
```{r}
x = get_posterior(x)
x = get_prior(x,model_types = c("tree","fitness"))
plot_inference(x,params = c("rn","rp","s"))

```

