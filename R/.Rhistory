m = ifelse(node == leav,delt_m,m)) %>% ungroup()
}
}
return(tree)
}
tree = get_average_tree(x,threshold = threshold)
tree
nodes = tree %>% pull(node)
nodes
params =  tree %>%
mutate(w_plus  = ifelse(paste0(node,"-") %in% nodes,0.5,1),
w_minus = ifelse(paste0(node,"-") %in% nodes,0.5,1)) %>% reshape2::melt() %>%
mutate(node = gsub(x = node,pattern = "-",replacement = "n")) %>%
mutate(node = gsub(x = node,pattern = "\\+",replacement = "p")) %>%
filter(!(variable == "p_switch" & value == 0)) %>%
filter(!(variable == "nu" & value == 1)) %>%
filter(!(variable %in% c("w_minus","w_plus") & value == 1)) %>%
mutate(variable = paste0(variable,"_",node)) %>% pull(variable)
params
params[params %in% all_variables]
all_variables = x$draws() %>% as.data.frame()  %>%
reshape2::melt() %>% pull(variable) %>% unique()
params = params[params %in% all_variables]
params
tree
posterior = as.data.frame(x$draws())[,colnames(x$draws() %>% as.data.frame()) %in% params]
posterior
ncol(posterior)
full_tree =  get_average_tree(x,threshold = NULL)
full_tree
nrow(full_tree) > nrow(tree)
tree = tree %>% mutate(leave = ifelse(!paste0(node,"-") %in% nodes,T,F))
leaves = tree %>% filter(leave) %>% pull(node)
tree
tree = tree %>% mutate(leave = ifelse(!paste0(node,"-") %in% nodes,T,F))
leaves = tree %>% filter(leave) %>% pull(node)
tree
leaves
leaves
leav = "--+"
paste0("delta_m_",leav)
tree = get_average_tree(x,threshold = threshold)
tree = tree %>% mutate(node = gsub(x = node,pattern = "-",replacement = "n")) %>%
mutate(node = gsub(x = node,pattern = "\\+",replacement = "p"))
nodes = tree %>% pull(node)
full_tree =  get_average_tree(x,threshold = NULL)
tree = tree %>% mutate(leave = ifelse(!paste0(node,"-") %in% nodes,T,F))
leaves = tree %>% filter(leave) %>% pull(node)
tree = get_average_tree(x,threshold = threshold)
tree = tree %>% mutate(node = gsub(x = node,pattern = "-",replacement = "n")) %>%
mutate(node = gsub(x = node,pattern = "\\+",replacement = "p"))
nodes = tree %>% pull(node)
params =  tree %>%
mutate(w_plus  = ifelse(paste0(node,"-") %in% nodes,0.5,1),
w_minus = ifelse(paste0(node,"-") %in% nodes,0.5,1)) %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & value == 0)) %>%
filter(!(variable == "nu" & value == 1)) %>%
filter(!(variable %in% c("w_minus","w_plus") & value == 1)) %>%
mutate(variable = paste0(variable,"_",node)) %>% pull(variable)
all_variables = x$draws() %>% as.data.frame()  %>%
reshape2::melt() %>% pull(variable) %>% unique()
params = params[params %in% all_variables]
posterior = as.data.frame(x$draws())[,colnames(x$draws() %>% as.data.frame()) %in% params]
full_tree =  get_average_tree(x,threshold = NULL)
tree = tree %>% mutate(leave = ifelse(!paste0(node,"n") %in% nodes,T,F))
leaves = tree %>% filter(leave) %>% pull(node)
tree
leaves
paste0("delta_m_",leav)
leaves = tree %>% filter(leave) %>% pull(node)
leaves
leav = "nnp"
colnames(posterior) == paste0("delta_m_",leav)
posterior[,colnames(posterior) == paste0("delta_m_",leav)]
posterior[,colnames(posterior) == paste0("delta_m_",leav)]
posterior[,colnames(posterior) == paste0("delta_m_",leav)] %>% mean()
substr(x = leav,start = 1,stop = nchar(leav)-1)
paste0("delta_m_",substr(x = leav,start = 1,stop = nchar(leav)-1))
paste0("phi_",substr(x = leav,start = 1,stop = nchar(leav)))
leav
(posterior[,colnames(posterior) == paste0("delta_m_",substr(x = leav,start = 1,stop = nchar(leav)-1))] -
posterior[,colnames(posterior) == paste0("m_",substr(x = leav,start = 1,stop = nchar(leav)-1))])*(
posterior[,colnames(posterior) == paste0("phi_",substr(x = leav,start = 1,stop = nchar(leav)))])
(posterior[,colnames(posterior) == paste0("delta_m_",substr(x = leav,start = 1,stop = nchar(leav)-1))] -
posterior[,colnames(posterior) == paste0("m_",substr(x = leav,start = 1,stop = nchar(leav)-1))])*(
posterior[,colnames(posterior) == paste0("phi_",substr(x = leav,start = 1,stop = nchar(leav)))]) %>% mean()
(posterior[,colnames(posterior) == paste0("delta_m_",substr(x = leav,start = 1,stop = nchar(leav)-1))] -
posterior[,colnames(posterior) == paste0("m_",substr(x = leav,start = 1,stop = nchar(leav)-1))])*(
posterior[,colnames(posterior) == paste0("phi_",substr(x = leav,start = 1,stop = nchar(leav)))]) %>% mean()
(posterior[,colnames(posterior) == paste0("delta_m_",substr(x = leav,start = 1,stop = nchar(leav)-1))] -
posterior[,colnames(posterior) == paste0("m_",substr(x = leav,start = 1,stop = nchar(leav)-1))])*(
posterior[,colnames(posterior) == paste0("phi_",substr(x = leav,start = 1,stop = nchar(leav)))])
mean((posterior[,colnames(posterior) == paste0("delta_m_",substr(x = leav,start = 1,stop = nchar(leav)-1))] -
posterior[,colnames(posterior) == paste0("m_",substr(x = leav,start = 1,stop = nchar(leav)-1))])*(
posterior[,colnames(posterior) == paste0("phi_",substr(x = leav,start = 1,stop = nchar(leav)))]))
tree
get_posterior = function(x,threshold = 0.1){
tree = get_average_tree(x,threshold = threshold)
tree = tree %>% mutate(node = gsub(x = node,pattern = "-",replacement = "n")) %>%
mutate(node = gsub(x = node,pattern = "\\+",replacement = "p"))
nodes = tree %>% pull(node)
params =  tree %>%
mutate(w_plus  = ifelse(paste0(node,"-") %in% nodes,0.5,1),
w_minus = ifelse(paste0(node,"-") %in% nodes,0.5,1)) %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & value == 0)) %>%
filter(!(variable == "nu" & value == 1)) %>%
filter(!(variable %in% c("w_minus","w_plus") & value == 1)) %>%
mutate(variable = paste0(variable,"_",node)) %>% pull(variable)
all_variables = x$draws() %>% as.data.frame()  %>%
reshape2::melt() %>% pull(variable) %>% unique()
params = params[params %in% all_variables]
posterior = as.data.frame(x$draws())[,colnames(x$draws() %>% as.data.frame()) %in% params]
full_tree =  get_average_tree(x,threshold = NULL)
if(nrow(full_tree) > nrow(tree)){
tree = tree %>% mutate(leave = ifelse(!paste0(node,"n") %in% nodes,T,F))
leaves = tree %>% filter(leave) %>% pull(node)
for (leav in leaves){
posterior[,colnames(posterior) == paste0("delta_m_",leav)] =
(posterior[,colnames(posterior) == paste0("delta_m_",substr(x = leav,start = 1,stop = nchar(leav)-1))] -
posterior[,colnames(posterior) == paste0("m_",substr(x = leav,start = 1,stop = nchar(leav)-1))])*(
posterior[,colnames(posterior) == paste0("phi_",substr(x = leav,start = 1,stop = nchar(leav)))])
posterior[,colnames(posterior) == paste0("m_",leav)] =
posterior[,colnames(posterior) == paste0("delta_m_",leav)]
if(substr(x = leav,start = 1,stop = nchar(leav)) == "n"){
posterior[,colnames(posterior) == paste0("vaf_minus_",leav)] =
posterior[,colnames(posterior) == paste0("vaf_minus_",substr(x = leav,start = 1,stop = nchar(leav)-1))]
}else{
posterior[,colnames(posterior) == paste0("vaf_minus_",leav)] =  rbeta(nrow(posterior),1,1e6)
}
if(substr(x = leav,start = 1,stop = nchar(leav)) == "p"){
posterior[,colnames(posterior) == paste0("vaf_plus_",leav)] =
posterior[,colnames(posterior) == paste0("vaf_plus_",substr(x = leav,start = 1,stop = nchar(leav)-1))]
}else{
posterior[,colnames(posterior) == paste0("vaf_plus_",leav)] =  rbeta(nrow(posterior),1,1e6)
}
}
}
return(posterior)
}
posterior = get_posterior(x,threshold = 0.1)
posterior
posterior %>% colnames()
get_posterior = function(x,threshold = 0.1){
tree = get_average_tree(x,threshold = threshold)
tree = tree %>% mutate(node = gsub(x = node,pattern = "-",replacement = "n")) %>%
mutate(node = gsub(x = node,pattern = "\\+",replacement = "p"))
nodes = tree %>% pull(node)
params =  tree %>%
mutate(w_plus  = ifelse(paste0(node,"-") %in% nodes,0.5,1),
w_minus = ifelse(paste0(node,"-") %in% nodes,0.5,1)) %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & value == 0)) %>%
filter(!(variable == "nu" & value == 1)) %>%
filter(!(variable %in% c("w_minus","w_plus") & value == 1)) %>%
mutate(variable = paste0(variable,"_",node)) %>% pull(variable)
all_variables = x$draws() %>% as.data.frame()  %>%
reshape2::melt() %>% pull(variable) %>% unique()
params = params[params %in% all_variables]
posterior = as.data.frame(x$draws())[,colnames(x$draws() %>% as.data.frame()) %in% params]
full_tree =  get_average_tree(x,threshold = NULL)
if(nrow(full_tree) > nrow(tree)){
tree = tree %>% mutate(leave = ifelse(!paste0(node,"n") %in% nodes,T,F))
leaves = tree %>% filter(leave) %>% pull(node)
for (leav in leaves){
posterior[,colnames(posterior) == paste0("delta_m_",leav)] =
(posterior[,colnames(posterior) == paste0("delta_m_",substr(x = leav,start = 1,stop = nchar(leav)-1))] -
posterior[,colnames(posterior) == paste0("m_",substr(x = leav,start = 1,stop = nchar(leav)-1))])*(
posterior[,colnames(posterior) == paste0("phi_",substr(x = leav,start = 1,stop = nchar(leav)))])
posterior[,colnames(posterior) == paste0("m_",leav)] =
posterior[,colnames(posterior) == paste0("delta_m_",leav)]
if(substr(x = leav,start = 1,stop = nchar(leav)) == "n"){
posterior[,colnames(posterior) == paste0("vaf_minus_",leav)] =
posterior[,colnames(posterior) == paste0("vaf_minus_",substr(x = leav,start = 1,stop = nchar(leav)-1))]
}else{
posterior[,colnames(posterior) == paste0("vaf_minus_",leav)] =  rbeta(nrow(posterior),1,1e6)
}
if(substr(x = leav,start = 1,stop = nchar(leav)) == "p"){
posterior[,colnames(posterior) == paste0("vaf_plus_",leav)] =
posterior[,colnames(posterior) == paste0("vaf_plus_",substr(x = leav,start = 1,stop = nchar(leav)-1))]
}else{
posterior[,colnames(posterior) == paste0("vaf_plus_",leav)] =  rbeta(nrow(posterior),1,1e6)
}
}
}
return(posterior %>% as_tibble())
}
posterior = get_posterior(x,threshold = 0.1)
posterior
params = c("rn","rp")
prior = NULL
variables = variables[!variables %in% c("lp__","lp_approx__")]
variables = colnames(posterior)
variables = variables[!variables %in% c("lp__","lp_approx__")]
if(!is.null(params)){
variables = variables[variables %in% params]}
post
post = posterior
if(!is.null(prior)){
prior = prior %>% as_tibble() %>% reshape2::melt() %>%
filter(variable %in% params) %>% mutate(type = "prior")}
if(!is.null(posterior)){
post = post %>% as_tibble() %>% reshape2::melt() %>%
filter(variable %in% params) %>% mutate(type = "post")}
sampling = rbind(prior,post)
nr = round(length(sampling$variable %>% unique())/4 + 0.5)
nc = min(length(sampling$variable %>% unique()),4)
ggplot(sampling) + geom_density(aes(x = value, alpha = type),fill = "steelblue") +
facet_wrap(~variable,scales = "free",nrow = nr, ncol = nc)  +
scale_alpha_manual(values = c("prior" = 0.4, "posterior" = 1)) +
CNAqc:::my_ggplot_theme() + theme(legend.position="none")
nr = round(length(sampling$variable %>% unique())/4 + 0.5)
nc = min(length(sampling$variable %>% unique()),4)
ggplot(sampling) + geom_density(aes(x = value, alpha = type),fill = "steelblue") +
facet_wrap(~variable,scales = "free",nrow = nr, ncol = nc)  +
scale_alpha_manual(values = c("prior" = 0.4, "posterior" = 1)) +
CNAqc:::my_ggplot_theme() + theme(legend.position="none")
nr
nr = round(length(sampling$variable %>% unique())/4 + 1)
nc = min(length(sampling$variable %>% unique()),4)
nr
nc
round(length(sampling$variable %>% unique())/4 + 1)
min(length(sampling$variable %>% unique()) + 1,4)
nr = round(length(sampling$variable %>% unique())/4 + 1)
nc = min(length(sampling$variable %>% unique()) + 1,4)
ggplot(sampling) + geom_density(aes(x = value, alpha = type),fill = "steelblue") +
facet_wrap(~variable,scales = "free",nrow = nr, ncol = nc)  +
scale_alpha_manual(values = c("prior" = 0.4, "posterior" = 1)) +
CNAqc:::my_ggplot_theme() + theme(legend.position="none")
sampling
colnames(posterior)
x
tree %>%
mutate(w_plus  = ifelse(paste0(node,"-") %in% nodes,0.5,1),
w_minus = ifelse(paste0(node,"-") %in% nodes,0.5,1)) %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & value == 0)) %>%
filter(!(variable == "nu" & value == 1)) %>%
filter(!(variable %in% c("w_minus","w_plus") & value == 1)) %>%
mutate(variable = paste0(variable,"_",node)) %>% pull(variable)
tree
all_variables %in% c("rate_n","rate_p")
params =  tree %>%
mutate(w_plus  = ifelse(paste0(node,"-") %in% nodes,0.5,1),
w_minus = ifelse(paste0(node,"-") %in% nodes,0.5,1)) %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & value == 0)) %>%
filter(!(variable == "nu" & value == 1)) %>%
filter(!(variable %in% c("w_minus","w_plus") & value == 1)) %>%
mutate(variable = paste0(variable,"_",node)) %>% pull(variable)
all_variables = x$draws() %>% as.data.frame()  %>%
reshape2::melt() %>% pull(variable) %>% unique()
all_variables %in% c("rate_n","rate_p")
params
all_variables
params
params =  tree %>%
mutate(w_plus  = ifelse(paste0(node,"-") %in% nodes,0.5,1),
w_minus = ifelse(paste0(node,"-") %in% nodes,0.5,1)) %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & value == 0)) %>%
filter(!(variable == "nu" & value == 1)) %>%
filter(!(variable %in% c("w_minus","w_plus") & value == 1)) %>%
mutate(variable = paste0(variable,"_",node),
variable = gsub(x = variable,pattern = "rate_",replacement = "r")) %>%
pull(variable)
params
all_variables = x$draws() %>% as.data.frame()  %>%
reshape2::melt() %>% pull(variable) %>% unique()
params = params[params %in% all_variables]
params
tree
tree = get_average_tree(x,threshold = threshold)
tree = tree %>% mutate(node = gsub(x = node,pattern = "-",replacement = "n")) %>%
mutate(node = gsub(x = node,pattern = "\\+",replacement = "p"))
nodes = tree %>% pull(node)
tree %>%
mutate(w_plus  = ifelse(paste0(node,"-") %in% nodes,0.5,1),
w_minus = ifelse(paste0(node,"-") %in% nodes,0.5,1)) %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & value == 0)) %>%
filter(!(variable == "nu" & value == 1)) %>%
filter(!(variable %in% c("w_minus","w_plus") & value == 1)) %>%
mutate(variable = paste0(variable,"_",node)) %>%
pull(variable)
all_variables = x$draws() %>% as.data.frame()  %>%
reshape2::melt() %>% pull(variable) %>% unique()
c(params[params %in% all_variables],"rn","rp")
get_posterior = function(x,threshold = 0.1){
tree = get_average_tree(x,threshold = threshold)
tree = tree %>% mutate(node = gsub(x = node,pattern = "-",replacement = "n")) %>%
mutate(node = gsub(x = node,pattern = "\\+",replacement = "p"))
nodes = tree %>% pull(node)
params =  tree %>%
mutate(w_plus  = ifelse(paste0(node,"-") %in% nodes,0.5,1),
w_minus = ifelse(paste0(node,"-") %in% nodes,0.5,1)) %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & value == 0)) %>%
filter(!(variable == "nu" & value == 1)) %>%
filter(!(variable %in% c("w_minus","w_plus") & value == 1)) %>%
mutate(variable = paste0(variable,"_",node)) %>%
pull(variable)
all_variables = x$draws() %>% as.data.frame()  %>%
reshape2::melt() %>% pull(variable) %>% unique()
params = c(params[params %in% all_variables],"rn","rp")
posterior = as.data.frame(x$draws())[,colnames(x$draws() %>% as.data.frame()) %in% params]
full_tree =  get_average_tree(x,threshold = NULL)
if(nrow(full_tree) > nrow(tree)){
tree = tree %>% mutate(leave = ifelse(!paste0(node,"n") %in% nodes,T,F))
leaves = tree %>% filter(leave) %>% pull(node)
for (leav in leaves){
posterior[,colnames(posterior) == paste0("delta_m_",leav)] =
(posterior[,colnames(posterior) == paste0("delta_m_",substr(x = leav,start = 1,stop = nchar(leav)-1))] -
posterior[,colnames(posterior) == paste0("m_",substr(x = leav,start = 1,stop = nchar(leav)-1))])*(
posterior[,colnames(posterior) == paste0("phi_",substr(x = leav,start = 1,stop = nchar(leav)))])
posterior[,colnames(posterior) == paste0("m_",leav)] =
posterior[,colnames(posterior) == paste0("delta_m_",leav)]
if(substr(x = leav,start = 1,stop = nchar(leav)) == "n"){
posterior[,colnames(posterior) == paste0("vaf_minus_",leav)] =
posterior[,colnames(posterior) == paste0("vaf_minus_",substr(x = leav,start = 1,stop = nchar(leav)-1))]
}else{
posterior[,colnames(posterior) == paste0("vaf_minus_",leav)] =  rbeta(nrow(posterior),1,1e6)
}
if(substr(x = leav,start = 1,stop = nchar(leav)) == "p"){
posterior[,colnames(posterior) == paste0("vaf_plus_",leav)] =
posterior[,colnames(posterior) == paste0("vaf_plus_",substr(x = leav,start = 1,stop = nchar(leav)-1))]
}else{
posterior[,colnames(posterior) == paste0("vaf_plus_",leav)] =  rbeta(nrow(posterior),1,1e6)
}
}
}
return(posterior %>% as_tibble())
}
posterior = get_posterior(tree,threshold = 0.1)
get_posterior = function(x,threshold = 0.1){
tree = get_average_tree(x,threshold = threshold)
tree = tree %>% mutate(node = gsub(x = node,pattern = "-",replacement = "n")) %>%
mutate(node = gsub(x = node,pattern = "\\+",replacement = "p"))
nodes = tree %>% pull(node)
params =  tree %>%
mutate(w_plus  = ifelse(paste0(node,"-") %in% nodes,0.5,1),
w_minus = ifelse(paste0(node,"-") %in% nodes,0.5,1)) %>% reshape2::melt() %>%
filter(!(variable == "p_switch" & value == 0)) %>%
filter(!(variable == "nu" & value == 1)) %>%
filter(!(variable %in% c("w_minus","w_plus") & value == 1)) %>%
mutate(variable = paste0(variable,"_",node)) %>%
pull(variable)
all_variables = x$draws() %>% as.data.frame()  %>%
reshape2::melt() %>% pull(variable) %>% unique()
params = c(params[params %in% all_variables],"rn","rp")
posterior = as.data.frame(x$draws())[,colnames(x$draws() %>% as.data.frame()) %in% params]
full_tree =  get_average_tree(x,threshold = NULL)
if(nrow(full_tree) > nrow(tree)){
tree = tree %>% mutate(leave = ifelse(!paste0(node,"n") %in% nodes,T,F))
leaves = tree %>% filter(leave) %>% pull(node)
for (leav in leaves){
posterior[,colnames(posterior) == paste0("delta_m_",leav)] =
(posterior[,colnames(posterior) == paste0("delta_m_",substr(x = leav,start = 1,stop = nchar(leav)-1))] -
posterior[,colnames(posterior) == paste0("m_",substr(x = leav,start = 1,stop = nchar(leav)-1))])*(
posterior[,colnames(posterior) == paste0("phi_",substr(x = leav,start = 1,stop = nchar(leav)))])
posterior[,colnames(posterior) == paste0("m_",leav)] =
posterior[,colnames(posterior) == paste0("delta_m_",leav)]
if(substr(x = leav,start = 1,stop = nchar(leav)) == "n"){
posterior[,colnames(posterior) == paste0("vaf_minus_",leav)] =
posterior[,colnames(posterior) == paste0("vaf_minus_",substr(x = leav,start = 1,stop = nchar(leav)-1))]
}else{
posterior[,colnames(posterior) == paste0("vaf_minus_",leav)] =  rbeta(nrow(posterior),1,1e6)
}
if(substr(x = leav,start = 1,stop = nchar(leav)) == "p"){
posterior[,colnames(posterior) == paste0("vaf_plus_",leav)] =
posterior[,colnames(posterior) == paste0("vaf_plus_",substr(x = leav,start = 1,stop = nchar(leav)-1))]
}else{
posterior[,colnames(posterior) == paste0("vaf_plus_",leav)] =  rbeta(nrow(posterior),1,1e6)
}
}
}
return(posterior %>% as_tibble())
}
posterior = get_posterior(x,threshold = 0.1)
posterior
posterior %>% colnames()
if(model_type == "tree"){
max_depth = tree %>% pull(level) %>% max()
model_prior = tree_inference_code(max_depth,likelihood = F)
}else{
tree = get_average_tree(x,threshold = NULL)
model_prior =  fitness_inference_code(tree,likelihood = F)
}
if(!is.null(prior)){
prior = prior %>% as_tibble() %>% reshape2::melt() %>%
filter(variable %in% params) %>% mutate(type = "prior")}
if(!is.null(posterior)){
post = post %>% as_tibble() %>% reshape2::melt() %>%
filter(variable %in% params) %>% mutate(type = "post")}
post = posterior
if(!is.null(prior)){
prior = prior %>% as_tibble() %>% reshape2::melt() %>%
filter(variable %in% params) %>% mutate(type = "prior")}
if(!is.null(post)){
post = post %>% as_tibble() %>% reshape2::melt() %>%
filter(variable %in% params) %>% mutate(type = "post")}
post
sampling = rbind(prior,post)
nr = round(length(sampling$variable %>% unique())/4 + 1)
nc = min(length(sampling$variable %>% unique()) + 1,4)
ggplot(sampling) + geom_density(aes(x = value, alpha = type),fill = "steelblue") +
facet_wrap(~variable,scales = "free",nrow = nr, ncol = nc)  +
scale_alpha_manual(values = c("prior" = 0.4, "posterior" = 1)) +
CNAqc:::my_ggplot_theme() + theme(legend.position="none")
post = posterior
post %>% as_tibble() %>% reshape2::melt()
params = c("rn","rp")
if(!is.null(prior)){
prior = prior %>% as_tibble() %>% reshape2::melt() %>%
filter(variable %in% params) %>% mutate(type = "prior")}
if(!is.null(post)){
post = post %>% as_tibble() %>% reshape2::melt() %>%
filter(variable %in% params) %>% mutate(type = "post")}
sampling = rbind(prior,post)
nr = round(length(sampling$variable %>% unique())/4 + 1)
nc = min(length(sampling$variable %>% unique()) + 1,4)
ggplot(sampling) + geom_density(aes(x = value, alpha = type),fill = "steelblue") +
facet_wrap(~variable,scales = "free",nrow = nr, ncol = nc)  +
scale_alpha_manual(values = c("prior" = 0.4, "posterior" = 1)) +
CNAqc:::my_ggplot_theme() + theme(legend.position="none")
1/8000
plot_inference = function(post,params = c("rn","rp"),prior = NULL){
if(!is.null(prior)){
prior = prior %>% as_tibble() %>% reshape2::melt() %>%
filter(variable %in% params) %>% mutate(type = "prior")}
if(!is.null(post)){
post = post %>% as_tibble() %>% reshape2::melt() %>%
filter(variable %in% params) %>% mutate(type = "post")}
sampling = rbind(prior,post)
nr = round(length(sampling$variable %>% unique())/4 + 1)
nc = min(length(sampling$variable %>% unique()) + 1,4)
ggplot(sampling) + geom_density(aes(x = value, alpha = type),fill = "steelblue") +
facet_wrap(~variable,scales = "free",nrow = nr, ncol = nc)  +
scale_alpha_manual(values = c("prior" = 0.4, "posterior" = 1)) +
CNAqc:::my_ggplot_theme() + theme(legend.position="none")
}
data = fromJSON(file = x$data_file())
data
x
x$cmdstan_summary()
x$cmdstan_summary() %>% as.data.frame()
x$cmdstan_summary() %>% as.tibble()
x$cmdstan_summary() %>% as_tibble()
x$cmdstan_summary()
x$output_files()
x$initialize()
x$draws()
x$draws() %>% dplyr::select(starts_with("vaf_minus"))
x$draws() %>% as.data.frame() %>% dplyr::select(starts_with("vaf_minus"))
x$draws() %>% as.data.frame() %>% dplyr::select(starts_with("vaf_minus")) %>% colnames()
gsub(x = x$draws() %>% as.data.frame() %>% dplyr::select(starts_with("vaf_minus")) %>% colnames(),
pattern = "vaf_minus_",replacement = "")
gsub(x = x$draws() %>% as.data.frame() %>% dplyr::select(starts_with("vaf_minus")) %>% colnames(),
pattern = "vaf_minus_",replacement = "") %>% max()
ndraws = 1000
threshold = 0.1
model_type = "tree"
x
data = fromJSON(file = x$data_file())
if(model_type == "tree"){
max_depth = gsub(x = x$draws() %>% as.data.frame() %>% dplyr::select(starts_with("vaf_minus")) %>% colnames(),
pattern = "vaf_minus_",replacement = "") %>% max()
model_prior = tree_inference_code(max_depth,likelihood = F)
}
gsub(x = x$draws() %>% as.data.frame() %>% dplyr::select(starts_with("vaf_minus")) %>% colnames(),
pattern = "vaf_minus_",replacement = "")
data = fromJSON(file = x$data_file())
if(model_type == "tree"){
max_depth = gsub(x = x$draws() %>% as.data.frame() %>% dplyr::select(starts_with("vaf_minus")) %>% colnames(),
pattern = "vaf_minus_",replacement = "") %>% nchar() %>% max() - 1
model_prior = tree_inference_code(max_depth,likelihood = F)
}
if(model_type == "fitness"){
tree = get_average_tree(x,threshold = threshold)
model_prior =  fitness_inference_code(tree,likelihood = F)
}
model_prior
prior <- rstan::sampling(model, data, chains = 1, warmup = 500, iter = ndraws)
library(rstan)
prior <- rstan::sampling(model_prior, data, chains = 1, warmup = 500, iter = ndraws)
model_prior
data
ndraws
prior <- rstan::sampling(model_prior, data, chains = 1, warmup = 500, iter = ndraws)
prior <- rstan::stan(model_code = model_prior,data =  data, chains = 1, warmup = 500, iter = ndraws)
prior
prior %>% as.data.frame() %>% as_tibble()
prior = prior %>% as.data.frame() %>% as_tibble()
prior <- rstan::stan(model_code = model_prior,data =  data, chains = 1,
warmup = 500, iter = ndraws,cores = 4)
prior
model <- cmdstan_model(model_code = model_prior)
prior <- rstan::stan(model_code = model_prior,data =  data, chains = 1,
warmup = 100, iter = ndraws,cores = 4)
prior <- rstan::stan(model_code = model_prior,data =  data, chains = 1,
warmup = 500, iter = ndraws,cores = 4)
prior = prior %>% as.data.frame() %>% as_tibble()
prior
post = posterior
params = c("rn","rp")
if(!is.null(prior)){
prior = prior %>% as_tibble() %>% reshape2::melt() %>%
filter(variable %in% params) %>% mutate(type = "prior")}
if(!is.null(post)){
post = post %>% as_tibble() %>% reshape2::melt() %>%
filter(variable %in% params) %>% mutate(type = "post")}
sampling = rbind(prior,post)
nr = round(length(sampling$variable %>% unique())/4 + 1)
nc = min(length(sampling$variable %>% unique()) + 1,4)
ggplot(sampling) + geom_density(aes(x = value, alpha = type),fill = "steelblue") +
facet_wrap(~variable,scales = "free",nrow = nr, ncol = nc)  +
scale_alpha_manual(values = c("prior" = 0.4, "posterior" = 1)) +
CNAqc:::my_ggplot_theme() + theme(legend.position="none")
